git clone https://github.com/mikxez/minicrm.git

cd minicrm

python -m venv venv

# Активировать на Windows:

venv\Scripts\activate

# Активировать на Mac/Linux:

source venv/bin/activate

pip install -r requirements.txt

Mini CRM - Система распределения лидов
uvicorn app.main:app --reload
После запуска откройте: http://127.0.0.1:8000/docs для доступа к Swagger UI
Модели данных
Система состоит из 5 основных сущностей:

Operator - оператор, который обрабатывает обращения. Имеет лимит нагрузки (max_load) и статус активности (is_active)

Lead - клиент, который может обращаться через разные источники. Идентифицируется по external_id, phone или email

Source - источник обращения (бот). Каждый источник имеет уникальный bot_id

OperatorSource - связывает операторов с источниками и задает веса распределения

LeadAssignment - конкретное обращение лида из источника к оператору

Связи:

Один Operator может быть назначен на несколько Source через OperatorSource

Один Lead может иметь несколько LeadAssignment (обращений из разных источников)

Один Source может иметь несколько LeadAssignment (обращений разных лидов)

Алгоритм распределения
Определение лида
Система ищет существующего лида в строгом порядке приоритета:

По external_id (внешний идентификатор)

По phone (телефон)

По email (email)

Если лид не найден ни по одному из параметров - создается новый.

Учет весов операторов
Для каждого источника задаются веса операторов через сущность OperatorSource. Например:

Оператор1: вес 10

Оператор2: вес 30

Оператор3: вес 60

Система использует взвешенный случайный выбор: вероятность выбора оператора = его вес / сумма всех весов. В примере выше распределение будет: 10%, 30%, 60%.

Учет лимитов нагрузки
Перед распределением система проверяет:

Оператор активен (is_active = true)

Текущая нагрузка оператора < максимального лимита (active_assignments < max_load)

Нагрузка рассчитывается как количество активных обращений (LeadAssignment со статусом "active") у оператора.

Если подходящих операторов нет
Когда нет доступных операторов (все неактивны или перегружены), система:

Создает обращение (LeadAssignment) без назначения оператора

Устанавливает статус обращения в "pending"

Возвращает успешный ответ, но без operator_id
